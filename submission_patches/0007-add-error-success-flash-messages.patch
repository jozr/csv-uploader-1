From 34118d8196bf1404feace431ed5ff8d2bf72d155 Mon Sep 17 00:00:00 2001
From: jozwright <jozwright@gmail.com>
Date: Tue, 2 Dec 2014 01:40:17 -0800
Subject: [PATCH 07/23] add error/success flash messages

---
 Gemfile      |  5 +++--
 Gemfile.lock |  3 +++
 db/schema.rb |  1 -
 main.rb      | 20 ++++++++++++--------
 4 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/Gemfile b/Gemfile
index 5e0ac1a..e4745ce 100644
--- a/Gemfile
+++ b/Gemfile
@@ -1,5 +1,6 @@
 source 'https://rubygems.org'
 
 gem 'activerecord'
-gem 'sinatra-activerecord'
-gem 'sinatra'
\ No newline at end of file
+gem 'sinatra'
+gem 'sinatra-flash'
+gem 'sinatra-activerecord'
\ No newline at end of file
diff --git a/Gemfile.lock b/Gemfile.lock
index 38fff79..36a5736 100644
--- a/Gemfile.lock
+++ b/Gemfile.lock
@@ -29,6 +29,8 @@ GEM
     sinatra-activerecord (2.0.3)
       activerecord (>= 3.2)
       sinatra (~> 1.0)
+    sinatra-flash (0.3.0)
+      sinatra (>= 1.0.0)
     thread_safe (0.3.4)
     tilt (1.4.1)
     tzinfo (1.2.2)
@@ -41,3 +43,4 @@ DEPENDENCIES
   activerecord
   sinatra
   sinatra-activerecord
+  sinatra-flash
diff --git a/db/schema.rb b/db/schema.rb
index 2a1eda4..eacb235 100644
--- a/db/schema.rb
+++ b/db/schema.rb
@@ -26,5 +26,4 @@ ActiveRecord::Schema.define(version: 20141201193952) do
     t.datetime "created_at"
     t.datetime "updated_at"
   end
-
 end
diff --git a/main.rb b/main.rb
index 270589e..b7c9d2c 100644
--- a/main.rb
+++ b/main.rb
@@ -1,9 +1,11 @@
 require 'pg'
 require 'sinatra'
+require 'sinatra/flash'
 require 'sinatra/activerecord'
 
 set :database, 'postgres://localhost/deal_a_day'
 DB = PG.connect({:dbname => 'deal_a_day'})
+enable :sessions
 
 class Detail < ActiveRecord::Base
   def self.total_revenue
@@ -14,18 +16,20 @@ class Detail < ActiveRecord::Base
     total
   end
 end
-
+ 
 get '/' do
   erb :index
 end
 
 post '/' do
-  File.open('uploads/' + params['upload'][:filename], "w") do |f|
-    f.write(params['upload'][:tempfile].read)
+  if params[:upload]
+    File.open('uploads/' + params['upload'][:filename], "w") do |f|
+      f.write(params['upload'][:tempfile].read)
+    end
+    file_name = File.absolute_path('uploads/' + params['upload'][:filename]) 
+    upload = DB.exec("COPY details(purchaser_name, description, price, amount, address, merchant_name) FROM '#{file_name}' WITH CSV HEADER DELIMITER AS ',';")
+    flash[:success] = "The total amount of revenue is $#{Detail.total_revenue}0. Lookin' good!"
+  else
+    flash[:error] = "You did not select a file to upload."
   end
-
-  file_name = File.absolute_path('uploads/' + params['upload'][:filename]) 
-  DB.exec("COPY details(purchaser_name, description, price, amount, address, merchant_name) FROM '#{file_name}' WITH CSV HEADER DELIMITER AS ',';")
-  
-  return "The total amount of revenue is #{Detail.total_revenue}. Lookin' good!"
 end
\ No newline at end of file
-- 
1.8.4

