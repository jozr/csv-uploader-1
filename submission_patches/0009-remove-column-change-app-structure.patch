From b1513b180bd709e2ab96aaf3007f9d433c5ba7cd Mon Sep 17 00:00:00 2001
From: jozwright <jozwright@gmail.com>
Date: Tue, 2 Dec 2014 13:32:28 -0800
Subject: [PATCH 09/23] remove column/change app structure

---
 db/migrate/20141202210836_remove_column.rb |  5 +++++
 db/schema.rb                               |  6 +++---
 lib/detail.rb                              | 27 +++++++++++++++++++++++++++
 main.rb                                    | 26 ++------------------------
 rake                                       |  0
 5 files changed, 37 insertions(+), 27 deletions(-)
 create mode 100644 db/migrate/20141202210836_remove_column.rb
 create mode 100644 lib/detail.rb
 create mode 100644 rake

diff --git a/db/migrate/20141202210836_remove_column.rb b/db/migrate/20141202210836_remove_column.rb
new file mode 100644
index 0000000..e80f4e9
--- /dev/null
+++ b/db/migrate/20141202210836_remove_column.rb
@@ -0,0 +1,5 @@
+class RemoveColumn < ActiveRecord::Migration
+  def change
+  	remove_column :details, :updated_at
+  end
+end
diff --git a/db/schema.rb b/db/schema.rb
index c3ad931..b5f6191 100644
--- a/db/schema.rb
+++ b/db/schema.rb
@@ -11,7 +11,7 @@
 #
 # It's strongly recommended that you check this file into your version control system.
 
-ActiveRecord::Schema.define(version: 20141201193952) do
+ActiveRecord::Schema.define(version: 20141202210836) do
 
   # These are extensions that must be enabled in order to support this database
   enable_extension "plpgsql"
@@ -19,11 +19,11 @@ ActiveRecord::Schema.define(version: 20141201193952) do
   create_table "details", force: true do |t|
     t.string   "purchaser_name"
     t.string   "description"
-    t.decimal  "price", precision: 8, scale: 2
+    t.decimal  "price",          precision: 8, scale: 2
     t.integer  "amount"
     t.string   "address"
     t.string   "merchant_name"
     t.datetime "created_at"
-    t.datetime "updated_at"
   end
+
 end
diff --git a/lib/detail.rb b/lib/detail.rb
new file mode 100644
index 0000000..bb3b196
--- /dev/null
+++ b/lib/detail.rb
@@ -0,0 +1,27 @@
+require 'pg'
+
+class Detail < ActiveRecord::Base
+
+  DB = PG.connect({:dbname => 'deal_a_day'})
+
+  def self.upload(file)
+    File.open('uploads/' + file[:filename], "w") do |f|
+      f.write(file[:tempfile].read)
+    end
+    file_name = File.absolute_path('uploads/' + file[:filename]) 
+    DB.exec("COPY details(purchaser_name, description, price, amount, address, merchant_name) FROM '#{file_name}' WITH CSV HEADER DELIMITER AS ',';")
+    DB.exec("UPDATE details SET created_at = NOW() WHERE created_at IS NULL;")
+  end
+
+  def self.latest_upload_revenue
+    total = 0
+    latest_upload = Detail.order('created_at').last
+    Detail.all.each do |d|
+      if d.created_at == latest_upload.created_at
+        total += d.price * d.amount
+      end
+    end
+    total
+  end
+
+end
\ No newline at end of file
diff --git a/main.rb b/main.rb
index ebcf382..62b0ea2 100644
--- a/main.rb
+++ b/main.rb
@@ -1,33 +1,11 @@
-require 'pg'
 require 'sinatra'
 require 'sinatra/flash'
 require 'sinatra/activerecord'
 
+Dir.glob('./lib/*.rb').each { |f| require f }
+
 set :database, 'postgres://localhost/deal_a_day'
-DB = PG.connect({:dbname => 'deal_a_day'})
 enable :sessions
-
-class Detail < ActiveRecord::Base
-  def self.upload(file)
-    File.open('uploads/' + file[:filename], "w") do |f|
-      f.write(file[:tempfile].read)
-    end
-    file_name = File.absolute_path('uploads/' + file[:filename]) 
-    DB.exec("COPY details(purchaser_name, description, price, amount, address, merchant_name) FROM '#{file_name}' WITH CSV HEADER DELIMITER AS ',';")
-    DB.exec("UPDATE details SET created_at = NOW() WHERE created_at IS NULL;")
-  end
-  
-  def self.latest_upload_revenue
-    total = 0
-    latest_upload = Detail.order('created_at').last
-    Detail.all.each do |d|
-      if d.created_at == latest_upload.created_at
-        total += d.price * d.amount
-      end
-    end
-    total
-  end
-end
  
 get '/' do
   erb :index
diff --git a/rake b/rake
new file mode 100644
index 0000000..e69de29
-- 
1.8.4

