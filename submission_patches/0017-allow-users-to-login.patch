From ec815c4cba69cdf2aab899209f68a48297a39c68 Mon Sep 17 00:00:00 2001
From: jozwright <jozwright@gmail.com>
Date: Wed, 3 Dec 2014 00:44:31 -0800
Subject: [PATCH 17/23] allow users to login

---
 lib/user.rb              |  5 +++--
 main.rb                  | 24 +++++++++++++++++++++++-
 uploads/example_data.csv |  5 -----
 views/layout.erb         |  3 ++-
 views/login.erb          |  5 +++++
 5 files changed, 33 insertions(+), 9 deletions(-)
 delete mode 100644 uploads/example_data.csv
 create mode 100644 views/login.erb

diff --git a/lib/user.rb b/lib/user.rb
index c77aec0..d0b614a 100644
--- a/lib/user.rb
+++ b/lib/user.rb
@@ -1,6 +1,7 @@
 require 'sinatra/activerecord'
 
 class User < ActiveRecord::Base
-  validates :email, :presence => true, format: { with: /\A[\w+\-.]+@[a-z\d\-]+(\.[a-z]+)*\.[a-z]+\z/i, on: :create }
+
+  validates :email, :presence => true
   validates :password, :presence => true
-end
\ No newline at end of file
+end
diff --git a/main.rb b/main.rb
index 97a3c06..bea011b 100644
--- a/main.rb
+++ b/main.rb
@@ -19,4 +19,26 @@ post '/' do
   else
     flash[:error] = "You did not select a file to upload.<br />#{link}"
   end
-end
\ No newline at end of file
+end
+
+get '/auth/login' do
+  erb :login
+end
+
+post '/auth/login' do
+  input = params['user']
+  user = User.create(email: input['email'], password: input['password'])
+  @@current_user_id = user.id
+  flash[:success] = 'You have successfully logged in!'
+  redirect('/')
+end
+
+get '/auth/logout' do
+  if @@current_user_id.nil?
+    flash[:success] = 'Nobody is logged in!'
+  else
+  	@@current_user_id = nil
+    flash[:success] = 'You have successfully logged out!'
+  end
+  redirect '/' 
+end
diff --git a/uploads/example_data.csv b/uploads/example_data.csv
deleted file mode 100644
index 20b562b..0000000
--- a/uploads/example_data.csv
+++ /dev/null
@@ -1,5 +0,0 @@
-purchaser name,item description,item price,purchase count,merchant address,merchant name
-Snake Plissken,$10 off $20 of food,10.0,2,987 Fake St,Bob's Pizza
-Amy Pond,$30 of awesome for $10,10.0,5,456 Unreal Rd,Tom's Awesome Shop
-Marty McFly,$20 Sneakers for $5,5.0,1,123 Fake St,Sneaker Store Emporium
-Snake Plissken,$20 Sneakers for $5,5.0,4,123 Fake St,Sneaker Store Emporium
diff --git a/views/layout.erb b/views/layout.erb
index d18f7ba..bab3467 100644
--- a/views/layout.erb
+++ b/views/layout.erb
@@ -4,7 +4,8 @@
   <title>Dr. Deal-a-Day</title>
 </head>
 <body>
-  <h1>Dr. Deal-a-Day</h1>
+  <p><a href="/auth/login">Log In</a> | <a href="/auth/logout">Log Out</a></p>
+  <h1>Dr. Deal-a-Day</h1> 
   <%= yield %>
 </body>
 </html>
\ No newline at end of file
diff --git a/views/login.erb b/views/login.erb
new file mode 100644
index 0000000..258f60e
--- /dev/null
+++ b/views/login.erb
@@ -0,0 +1,5 @@
+<form action="/auth/login" method="post">
+  <p>Username: <input type="text" name="user[email]" /></p>
+  <p>Password: <input type="password" name="user[password]" /></p>
+  <input type="submit" value="Log In" />
+</form>
\ No newline at end of file
-- 
1.8.4

